<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="NMsim">
<title>NMsim -- Simulation of New Subjects • NMsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="NMsim -- Simulation of New Subjects">
<meta property="og:description" content="NMsim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.4.915</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/NMsim-basics.html">NMsim -- Simulation of New Subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-config.html">NMsim Configuration</a>
    <a class="dropdown-item" href="../articles/NMsim-methods.html">NMsim - Additional Simulation Methods</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>NMsim -- Simulation of New Subjects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/philipdelff/NMsim/blob/HEAD/vignettes/NMsim-basics.Rmd" class="external-link"><code>vignettes/NMsim-basics.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-basics.Rmd</code></div>
    </div>

    
    
<p>Built 2023-11-04 using NMsim 0.0.4.915.</p>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<p>This vignettes aims at enabling you to</p>
<ul>
<li><p>Use <code>NMsim</code> to simulate Nonmem models with a given
input data set</p></li>
<li><p>Distinguish between and perform the most common types of
simulations:</p></li>
<li><p>new subjects,</p></li>
<li><p>Simulate multiple new subjects and derive prediction
intervals</p></li>
<li><p>Simulate more than one Nonmem model in one <code><a href="../reference/NMsim.html">NMsim()</a></code>
function call</p></li>
<li><p>Important arguments</p></li>
<li><p>Speed up NMsim by avoiding large table statements</p></li>
<li><p>Add residual variability to an already performed model simulation
using <code>NMsim</code>.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>You should have configured <code>NMsim</code> with the path to the
Nonmem installation and maybe also PSN. See <a href="https://philipdelff.github.io/NMsim/articles/NMsim-config.html"><code>NMsim-config.html</code></a>.
Don’t worry - it is very easy.</p>
</div>
<div class="section level2">
<h2 id="estimation-based-on-single-dose-simulation-of-multiple-doses">Estimation based on single dose, simulation of multiple doses<a class="anchor" aria-label="anchor" href="#estimation-based-on-single-dose-simulation-of-multiple-doses"></a>
</h2>
<p>The situation is like this: We collected PK and PD data from a single
ascending dose trial on a drug candidate. The following plot shows the
data for no other reason than pointing out clearly that the data
informing the model was single dose, and we will be simulating a
different dosing regimen.</p>
<p><img src="NMsim-basics_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>A PK model was estimated using Nonmem. We have on file the model
input and output control streams (here with extensions <code>.mod</code>
and <code>.lst</code> respetively), parameter estimates
(<code>.ext</code>) and estimated random effects
(<code>.phi</code>).</p>
<p>We want to predict concentrations in a multiple dose regimen. This is
a regimen that we have not studied in clinical trials so far, and we
have decided to use population PK simulations for this purpose.</p>
<div class="section level3">
<h3 id="generating-a-simulation-input-data-set">Generating a simulation input data set<a class="anchor" aria-label="anchor" href="#generating-a-simulation-input-data-set"></a>
</h3>
<p>The pop PK model was estimated using an ADVAN subroutine with
extravascular dosing in compartment 1 and the central compartment is
compartment 2. This information is needed because the compartment
numbers in the simulation data set will be created to match this. We
shall see that this is the only information needed about the model for
<code>NMsim</code> to be able to simulate it.</p>
<p>It does not matter to NMsim how we create a simulation data set as
long as we get it into a data.frame structure. For the example, we used
functions included with NMsim, but you can use anything. We create a
regimen with a loading dose of 300 mg followed by 150 QD for 6 days.
Notice that the compartment numbers match the compartment numbers that
were used when estimating the model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### multiple dose regimens with loading are easily created with NMcreateDoses too</span></span>
<span><span class="co">## We use ADDL+II (either method easy)</span></span>
<span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span>,AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">150</span><span class="op">)</span>,addl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ADDL<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>,II<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">doses</span>,trt<span class="op">=</span><span class="st">"300 mg then 150 mg QD"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Add simulation records - longer for QD regimens</span></span>
<span><span class="va">dat.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addEVID2.html">addEVID2</a></span><span class="op">(</span><span class="va">doses</span>,time.sim<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fl">24</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## sort data set </span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Adding a row identifier (generally not necessary)</span></span>
<span><span class="va">dat.sim</span><span class="op">$</span><span class="va">ROW</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat.sim</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">write_fst</span><span class="op">(</span><span class="va">dat.sim</span>,<span class="st">"simulate-results/dat_sim.fst"</span><span class="op">)</span></span></code></pre></div>
<p>We check the simulation data set for various potential issues in
Nonmem data sets using <code><a href="https://philipdelff.github.io/NMdata/reference/NMcheckData.html" class="external-link">NMdata::NMcheckData</a></code> and summarize
the number of doses and observations:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">NMcheckData</span><span class="op">(</span><span class="va">dat.sim</span>,type.data<span class="op">=</span><span class="st">"sim"</span><span class="op">)</span></span>
<span><span class="co">#&gt; No findings. Great!</span></span></code></pre></div>
<p>A brief overview of the number of events broken down by event type
<code>EVID</code> and dose amount <code>AMT</code>:</p>
<table class="table">
<thead><tr class="header">
<th align="left">trt</th>
<th align="right">EVID</th>
<th align="right">AMT</th>
<th align="right">Nrows</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">300 mg then 150 mg QD</td>
<td align="right">1</td>
<td align="right">150</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">300 mg then 150 mg QD</td>
<td align="right">1</td>
<td align="right">300</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">300 mg then 150 mg QD</td>
<td align="right">2</td>
<td align="right">NA</td>
<td align="right">169</td>
</tr>
</tbody>
</table>
<p>Showing the top five rows for understanding what the data now looks
like. Notice that the following are <em>not</em> issues:</p>
<ul>
<li>Data contains a mix of numeric and non-numeric columns</li>
<li>Columns are not sorted in Nonmem-friendly style with non-numeric
columns to the right</li>
</ul>
<pre><code><span><span class="co">#&gt;    ID TIME EVID CMT AMT II ADDL MDV                   trt DV ROW</span></span>
<span><span class="co">#&gt; 1:  1    0    1   1 300  0    0   1 300 mg then 150 mg QD NA   1</span></span>
<span><span class="co">#&gt; 2:  1    0    2   2  NA NA   NA   1 300 mg then 150 mg QD NA   2</span></span>
<span><span class="co">#&gt; 3:  1    1    2   2  NA NA   NA   1 300 mg then 150 mg QD NA   3</span></span>
<span><span class="co">#&gt; 4:  1    2    2   2  NA NA   NA   1 300 mg then 150 mg QD NA   4</span></span>
<span><span class="co">#&gt; 5:  1    3    2   2  NA NA   NA   1 300 mg then 150 mg QD NA   5</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="simulation-of-a-new-subject">Simulation of a new subject<a class="anchor" aria-label="anchor" href="#simulation-of-a-new-subject"></a>
</h2>
<p>This is the first time we are using <code>NMsim</code>, and we just
want to try the simplest thing we can think of. Simulate a new subject
on the considerd multiple dose regimen with our estimated PK model from
the single dose study.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu">file.project</span><span class="op">(</span><span class="st">"nonmem/xgxr021.mod"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                data<span class="op">=</span><span class="va">dat.sim</span><span class="op">)</span></span></code></pre></div>
<p>We plot population and individual predictions as the simulations of
(in this case) the typical subject and one simulated subject. The
variable called <code>Y</code> is the individual prediction plus
residual variability. paper. The code is included to show that the
results from <code>NMsim</code> are ready to be plotted. The main reason
data is transformed to long format (<code>melt</code>) is to get ggplot2
to generate the legend automatically.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span>measure.vars<span class="op">=</span><span class="fu">cc</span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span>,<span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">datl</span>,<span class="fu">aes</span><span class="op">(</span><span class="va">TIME</span>,<span class="va">value</span>,colour<span class="op">=</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="va">variable</span><span class="op">!=</span><span class="st">"Y"</span><span class="op">]</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span>data<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="va">variable</span><span class="op">==</span><span class="st">"Y"</span><span class="op">]</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">trt</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-basics_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>The reason we can plot a simulation with residual variability is that
the control stream includes a variable <code>Y</code> defined with
residual variability in <code>$ERROR</code>:</p>
<pre><code><span>  <span class="va">Y</span><span class="op">=</span><span class="cn">F</span><span class="op">+</span><span class="cn">F</span><span class="op">*</span><span class="fu">ERR</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="fu">ERR</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre>
<p>More on residual variability in case you don’t have such a line later
in this paper.</p>
</div>
<div class="section level2">
<h2 id="what-happened">What happened?<a class="anchor" aria-label="anchor" href="#what-happened"></a>
</h2>
<p><code>NMsim</code> uses automation tools from <code>NMdata</code>
to</p>
<ul>
<li>Save the data in a Nonmem-friendly format</li>
<li>Create a simulation control stream based on the referenced input
control stream</li>
<li>Update the initial values based with estimated values</li>
<li>Modify input data-related sections for reading input siulation
data</li>
<li>Modify output table file names and paths to generate simulation
output tables</li>
<li>Run Nonmem</li>
<li>Read output tables and combine them with input data into one data
object</li>
</ul>
<p>The generated files have all been stored in a folder called
<code>NMsim</code> next to the estimation control stream. More on that
shortly in the section “A few basic additional arguments to
<code>NMsim</code>”.</p>
<p>Let’s see the first few lines of the returned object:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;    ROW ID TIME EVID CMT AMT II ADDL DV MDV   TVKA   TVV2   TVV3   TVCL     KA</span></span>
<span><span class="co">#&gt; 1:   1  1    0    1   1 300  0    0  0   1 2.1666 75.729 150.06 13.978 2.1666</span></span>
<span><span class="co">#&gt; 2:   2  1    0    2   2  NA NA   NA  0   1 2.1666 75.729 150.06 13.978 2.1666</span></span>
<span><span class="co">#&gt; 3:   3  1    1    2   2  NA NA   NA  0   1 2.1666 75.729 150.06 13.978 2.1666</span></span>
<span><span class="co">#&gt;        V2     V3     CL      Q  IPRED      Y   PRED RES WRES</span></span>
<span><span class="co">#&gt; 1: 56.493 150.06 24.289 8.4865 0.0000 0.0000 0.0000   0    0</span></span>
<span><span class="co">#&gt; 2: 56.493 150.06 24.289 8.4865 0.0000 0.0000 0.0000   0    0</span></span>
<span><span class="co">#&gt; 3: 56.493 150.06 24.289 8.4865 3.2364 3.5774 2.8907   0    0</span></span>
<span><span class="co">#&gt;                      trt                model nmout</span></span>
<span><span class="co">#&gt; 1: 300 mg then 150 mg QD NMsim_xgxr021_noname  TRUE</span></span>
<span><span class="co">#&gt; 2: 300 mg then 150 mg QD NMsim_xgxr021_noname  TRUE</span></span>
<span><span class="co">#&gt; 3: 300 mg then 150 mg QD NMsim_xgxr021_noname  TRUE</span></span></code></pre></div>
<p>Notice a few things about the returned data:</p>
<ul>
<li>All columns from the output tables defined in the input control
stream are there. We will soon learn how to modify this</li>
<li>Input data columns are there too (like <code>trt</code>).</li>
<li>Additional columns (<code>model</code> and <code>nmout</code>) may
be familiar to <code>NMdata</code> users.</li>
<li>We will soon learn where the “_noname” in the <code>model</code>
column comes from.</li>
</ul>
</div>
<div class="section level2">
<h2 id="multiple-models">Multiple models<a class="anchor" aria-label="anchor" href="#multiple-models"></a>
</h2>
<p>Before we continue with that model, we want to compare a simulation
based on this model to another model we are considering.
<code>NMsim</code> can do this and collect the data into one object:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## file.mod &lt;- "../nonmem/xgxr014.mod"</span></span>
<span><span class="va">files.2.mod</span> <span class="op">&lt;-</span> <span class="fu">file.project</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nonmem/xgxr021.mod"</span>,<span class="st">"nonmem/xgxr114.mod"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simres.2models</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">files.2.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">dat.sim</span></span>
<span>                        <span class="op">)</span></span></code></pre></div>
<p>In case multiple models are provided, <code>NMsim</code> simply loops
over them. It does collect all the results, and we can use the
<code>model</code> column to separate the two simulations. Since we are
so far just simulating on subject with each model, it makes litlle sense
to compare individual preditions. We just plot the population prediction
(<code>PRED</code>):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">simres.2models</span>,<span class="fu">aes</span><span class="op">(</span><span class="va">TIME</span>,<span class="va">PRED</span>,colour<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trt"</span><span class="op">)</span>,scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-basics_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>For simplicity, we shall show the rest of the examples for just one
model. Any of them could be run on multiple models the same way as shown
above.</p>
<!-- subproblems vs repetition of input data -->
</div>
<div class="section level2">
<h2 id="a-few-basic-additional-arguments-to-nmsim">A few basic additional arguments to <code>NMsim</code><a class="anchor" aria-label="anchor" href="#a-few-basic-additional-arguments-to-nmsim"></a>
</h2>
<p>The first couple of examples were run with the bare minimum of
arguments - estimation control stream and simulation data set. You are
obviously encouraged to read the help of <code>NMsim</code> to learn
about the many useful features it has, and you will learn some more in
this vignette. But there are a few arguments that you should learn about
at this point already. Here they are:</p>
<ul>
<li>
<code>dir.sims</code> Path to a folder in which all generated files
will be stored. Use this to avoid <code>NMsim</code> will write into the
directories where your estimation models are. They may not belong there
at all. You may want to separate the model development step from the
post-processing step. You are encouraged to explore what
<code>NMsim</code> leaves in this directory (you will find fully
reproducible simulation Nonmem runs including simulation input
data).</li>
<li>
<code>name.sim</code> Give your simulation a meaningfull name. We
did not do this above, so <code>NMsim</code> called it “noname”.</li>
<li>
<code>text.table</code> Very important. This redefines the output
table section from the estimation control stream to the simulation
control stream. The estimation control stream may have too many
variables printed (which will make Nonmem slow), or it may not have some
that are useful for the simulation analysis. See how this is used below.
Once you get used to this argument, you will use it very
frequently.</li>
<li>
<code>seed</code> A numeric value that will be used in Nonmem’s
$SIMULATION section</li>
</ul>
<p>You will learn about a few more arguments in the next examples.</p>
</div>
<div class="section level2">
<h2 id="most-common-reasons-for-nmsim-to-fail-or-be-slow">Most common reasons for <code>NMsim</code> to fail or be slow<a class="anchor" aria-label="anchor" href="#most-common-reasons-for-nmsim-to-fail-or-be-slow"></a>
</h2>
<p>If <code>NMsim</code> can find the Nonmem executable and/or PSN, it
should work on basically any models where where it makes sense to
replace the <code>$ESTIMATION</code> by a <code>$SIMULATION</code>. If
<code>NMsim</code> fails or behaves unexpectedly, make sure to read the
output from Nonmem in the R console. If <code>NMsim</code> complains it
cannot find the output tables, it is likely because Nonmem failed and
did not generate them.</p>
<p>There is one thing about the Nonmem model evaluation you have to
remember. Nonmem cannot run a model if it uses variables that are
unavailable. It may be a covariate in the model that you did not include
in your data set. And often the estimation models include variables in
output tables that were not used for anything else by Nonmem than being
read from the input data set and printed in output tables. In fact, this
was exactly why we included a row identifier calle <code>ROW</code> when
generating the simulation data set. If we do not do that, we get this
error:</p>
<pre><code>Starting NMTRAN
 
 AN ERROR WAS FOUND IN THE CONTROL STATEMENTS.
 
AN ERROR WAS FOUND ON LINE 60 AT THE APPROXIMATE POSITION NOTED:
 $TABLE ROW TVKA TVV2 TVV3 TVCL KA V2 V3 CL Q PRED IPRED Y NOPRINT FILE=NMsim_xgxr021_noname.tab
         X  
 THE CHARACTERS IN ERROR ARE: ROW
  479  THIS ITEM IS NOT LISTED IN MODULE NMPRD4 AND MAY NOT BE DISPLAYED.
cp: cannot stat 'NMsim_xgxr021_noname.tab': No such file or directory
Error in NMscanTables(file, quiet = TRUE, as.fun = "data.table", col.row = col.row,  : 
  NMscanTables: File not found: /home/philip/R/x86_64-pc-linux-gnu-library/4.2/NMsim/examples/nonmem/NMsim/xgxr021_noname/NMsim_xgxr021_noname.tab. Did you copy the lst file but forgot table file?
Results could not be read.</code></pre>
<p>Nonmem gets to writing the <code>$TABLE</code> but cannot find a
variable called <code>ROW</code>. Again, we fixed that by including
<code>ROW</code>. In many cases, the best way to fix this is to reduce
the <code>$TABLE</code> section using the <code>text.table</code>
argument. All we need from the simulation results are population and
individual predictions anyway. We could have omitted <code>ROW</code> in
the input data set and done something as simple as</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                data<span class="op">=</span><span class="va">dat.sim</span>,</span>
<span>                text.table<span class="op">=</span><span class="st">"PRED IPRED Y"</span><span class="op">)</span></span></code></pre></div>
<p><code>text.table</code> can help avoid many of these problems. And if
<code>NMsim</code> is slow, this is a potentially a very large
low-hanging fruit. In a benchmark example, I reduced a (very large)
simulation run time from ~1.5 hours to ~7 minutes this way.</p>
</div>
<div class="section level2">
<h2 id="more-subjects-and-prediction-intervals">More subjects and prediction intervals<a class="anchor" aria-label="anchor" href="#more-subjects-and-prediction-intervals"></a>
</h2>
<p>To create a prediction interval based on the selected model, we need
to simulate multiple new subjects. There are two ways to easily obtain
that. One is to repeat (<code>rbind</code>) the simulation input
dataset, one repetetion per new subject, and then update the
<code>ID</code> column to get distinct subjects.</p>
<div class="section level3">
<h3 id="multiple-subjects-created-in-simulation-input-data">Multiple subjects created in simulation input data<a class="anchor" aria-label="anchor" href="#multiple-subjects-created-in-simulation-input-data"></a>
</h3>
<p>The follwing shows how one could generate 1000 subjects using
<code>data.table</code>. (I use <code>data.table</code> a lot, if you
can provide a good way to do this without, I am happy to include
that).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim.1000</span> <span class="op">&lt;-</span> <span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://philipdelff.github.io/NMdata/reference/egdt.html" class="external-link">egdt</a></span><span class="op">(</span></span>
<span>                            <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">dat.sim</span><span class="op">)</span><span class="op">[</span>,<span class="op">!</span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span><span class="op">]</span></span>
<span>                           ,</span>
<span>                            <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ID<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span></span>
<span>                        <span class="op">)</span></span>
<span><span class="va">dat.sim.1000</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">trt</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## order with respect to new IDs</span></span>
<span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.1000</span>,<span class="va">trt</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span>
<span><span class="co">## check dataset</span></span>
<span><span class="fu">NMcheckData</span><span class="op">(</span><span class="va">dat.sim.1000</span>,type.data<span class="op">=</span><span class="st">"sim"</span><span class="op">)</span></span></code></pre></div>
<p>We now simulate 1000 subjects by plugging in this data object:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.n1000.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">dat.sim.1000</span>,</span>
<span>                        dir.sims<span class="op">=</span><span class="st">"~/NMsim_vignette"</span>, <span class="co">## where to store simulation files</span></span>
<span>                        name.sim<span class="op">=</span><span class="st">"N1000_datarep"</span></span>
<span>                        <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multiple-subjects-generated-by-nonmem">Multiple subjects generated by Nonmem<a class="anchor" aria-label="anchor" href="#multiple-subjects-generated-by-nonmem"></a>
</h3>
<p>The other way to simulate multiple subjects is making use of Nonmem’s
<code>SUBPROBLEMS</code> simulation feature which makes Nonmem rerun the
simulation the specified number of times. Notice that to do this, we use
the <code>dat.sim</code> data without the 1000 replications. We then
make use of the NMREP column generated by
<code><a href="https://philipdelff.github.io/NMdata/reference/NMscanData.html" class="external-link">NMdata::NMscanData</a></code> to redefine the <code>ID</code>
column:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>simres.n1000<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">NMsim</span>(<span class="at">file.mod=</span>file.mod,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data=</span>dat.sim,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">subproblems=</span><span class="dv">1000</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dir.sims=</span><span class="st">"~/NMsim_vignette"</span>, <span class="do">## where to store simulation files</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">name.sim=</span><span class="st">"N1000_subproblems"</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>simres.n1000<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(simres.n1000<span class="fl">.2</span>)[,ID<span class="sc">:</span><span class="er">=</span>.GRP,by<span class="ot">=</span>.(NMREP,ID,trt)]</span></code></pre></div>
<p>The two approaches are computationally about equally fast, the most
significant difference probably being in Nonmem reading a smaller or
larger simulation input data file. Unless the input dataset becomes very
large, it is merely a question of preference of the modeler which one to
use. In a case where the simulated patients need different dosing or
sample schedules, the manual construction of the data is needed -
because it’s not a straightforward replication.</p>
</div>
<div class="section level3">
<h3 id="the-prediction-interval">The prediction interval<a class="anchor" aria-label="anchor" href="#the-prediction-interval"></a>
</h3>
<p>We now plot a prediction interval - in this case based on the results
of the simulation using <code>SUBPROBLEMS</code>; this makes no
difference to how to derive the prediction interval.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.pi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.n1000.2</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">IPRED</span>,probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>,<span class="fl">.5</span>,<span class="fl">.95</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,<span class="fu">cc</span><span class="op">(</span><span class="va">ll</span>,<span class="va">median</span>,<span class="va">ul</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                           by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">trt</span>,<span class="va">TIME</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">simres.pi</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="st">"pi"</span></span>
<span><span class="va">simres.pi</span><span class="op">$</span><span class="va">pi.cover</span> <span class="op">&lt;-</span> <span class="st">"90%"</span></span>
<span></span>
<span><span class="va">p.pi.typ</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">simres.pi</span>,<span class="fu">aes</span><span class="op">(</span><span class="va">TIME</span>,fill<span class="op">=</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin<span class="op">=</span><span class="va">ll</span>,ymax<span class="op">=</span><span class="va">ul</span>,alpha<span class="op">=</span><span class="va">pi.cover</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y<span class="op">=</span><span class="va">median</span>,colour<span class="op">=</span><span class="va">trt</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">scale_alpha_manual</span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"90%"</span><span class="op">=</span><span class="fl">.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hours since first dose"</span>,y<span class="op">=</span><span class="st">"Concentration (ng/mL)"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p.pi.typ</span></span></code></pre></div>
<p><img src="NMsim-basics_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="read-previously-generated-simulations">Read previously generated simulations<a class="anchor" aria-label="anchor" href="#read-previously-generated-simulations"></a>
</h2>
<p>There is no need to save simulation results because they are already
saved by <code>NMsim</code>. Instead, use arguments
<code>dir.sims</code> and <code>name.sim</code> to make sure to get a
meaningful structure for the generated files. Then read the results with
<code><a href="https://philipdelff.github.io/NMdata/reference/NMscanData.html" class="external-link">NMdata::NMscanData</a></code>. <code>merge.by.row=FALSE</code> because
there is no reason to combine <code>NMsim</code> datasets using a row
identifier.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://philipdelff.github.io/NMdata/" class="external-link">NMdata</a></span><span class="op">)</span></span>
<span><span class="va">simres.n1000.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://philipdelff.github.io/NMdata/reference/NMscanData.html" class="external-link">NMscanData</a></span><span class="op">(</span><span class="st">"~/NMsim_vignette/xgxr021_N1000_datarep/NMsim_xgxr021_N1000_datarep.lst"</span>,merge.by.row<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>In fact, that is also what <code>NMsim</code> does once Nonmem has
run.</p>
</div>
<div class="section level2">
<h2 id="add-residual-variability">Add residual variability<a class="anchor" aria-label="anchor" href="#add-residual-variability"></a>
</h2>
<p>The best way to simulate with residual variability is to include the
it in the estimation control stream as described in this vignette.
<code>NMsim</code> currently does not provide any automated way to add
simulation of residual variability with Nonmem. It does provide a method
to simulate residual variability in R, based on the Nonmem parameter
estimates. This should only be used in case one has an existing Nonmem
without residual variability simulated, and it is not feasible to modify
the model control stream for some reason. The function is called
<code><a href="../reference/addResVar.html">addResVar()</a></code> and supports additive, proportional, and
combined (additive and proportional) error models. It can also add the
residual error on log scale (exponential error model).</p>
<p><code>addResVar</code> supports both estimation using
<code>$SIGMA</code> and <code>$THETA</code> (in Nonmem). The user has to
specify which of the two methods were used in the Nonmem model using the
<code>par.type</code> argument. The other thing that must be specified
is the parameter numbers for the standard deviations or variances. The
model simulated in this vignette has this combined error model estimated
using the <code>$SIGMA</code> matrix:</p>
<pre><code><span><span class="va">Y</span><span class="op">=</span><span class="cn">F</span><span class="op">+</span><span class="cn">F</span><span class="op">*</span><span class="fu">ERR</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span><span class="fu">ERR</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre>
<p>We now specify for <code>addResVar</code> to find the variance for
the proportional component in <code>$SIGMA[1,1]</code> and the one for
the additive component in <code>$SIGMA[2,2]</code>. In this case where
<code>SIGMA</code> is used, the off-diagonal (covariance) elements of
the <code>$SIGMA</code> matrix are also used for the simulation.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.with.resvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addResVar.html">addResVar</a></span><span class="op">(</span><span class="va">simres</span>,path.ext<span class="op">=</span><span class="fu"><a href="https://philipdelff.github.io/NMdata/reference/fnExtension.html" class="external-link">fnExtension</a></span><span class="op">(</span><span class="va">file.mod</span>,<span class="st">"ext"</span><span class="op">)</span>,par.type<span class="op">=</span><span class="st">"SIGMA"</span>,prop<span class="op">=</span><span class="fl">1</span>,add<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>If <code>par.type="THETA"</code> the default assumption is that the
thetas represent standard deviation (in contrast to when using
<code>par.type="SIGMA"</code>). This can be modified using the
<code>scale.par</code> argument. There are arguments to avoid negative
observations and several other features. But again, this should be the
last resort.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
