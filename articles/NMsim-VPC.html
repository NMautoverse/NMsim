<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="NMsim">
<title>VPC simulations â€¢ NMsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="VPC simulations">
<meta property="og:description" content="NMsim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.6.914</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulation with Parameter Uncertainty</a>
    <a class="dropdown-item" href="../articles/NMsim-ResidVar.html">NMsim - Simulation of residual variability</a>
    <a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse simulated subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-TypSubj.html">Simulation of typical subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-VPC.html">VPC simulations</a>
    <a class="dropdown-item" href="../articles/NMsim-basics.html">Simulation of New Subjects</a>
    <a class="dropdown-item" href="../articles/NMsim-config.html">NMsim Configuration</a>
    <a class="dropdown-item" href="../articles/NMsim-methods.html">Simulate subjects using Emperical Bayes Estimates (Etas/Phis)</a>
    <a class="dropdown-item" href="../articles/NMsim-speed.html">NMsim and speed</a>
    <a class="dropdown-item" href="../articles/NMsim-varyPars.html">Simulate with modified parameter values</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>VPC simulations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/philipdelff/NMsim/blob/HEAD/vignettes/NMsim-VPC.Rmd" class="external-link"><code>vignettes/NMsim-VPC.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-VPC.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="simulations-for-visual-predictive-checks-vpc">Simulations for Visual Predictive Checks (VPC)<a class="anchor" aria-label="anchor" href="#simulations-for-visual-predictive-checks-vpc"></a>
</h2>
<p>This vignette shows how to generate simulations for generation of VPC
plots. While <code>NMsim</code> does not include any functionality for
summarizing quantiles or plotting, it provides powerful ways to obtain
the simulated data needed. We shall see how the <code>tidyvpc</code>
package easily creates VPC plots based on the simulation results.</p>
</div>
<div class="section level2">
<h2 id="default-option-reuse-estimation-data-for-simulation">Default option: reuse estimation data for simulation<a class="anchor" aria-label="anchor" href="#default-option-reuse-estimation-data-for-simulation"></a>
</h2>
<p>Normally, the two main arguments to NMsim are the path to the input
control stream (<code>file.mod</code>) and the simulation input data set
(<code>data</code>). But if we leave out the the <code>data</code>
argument, NMsim will re-use the estimation data for the simulation. That
is the simulation we need for a VPC. We will use an example model
included with NMsim:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">file.project</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples"</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span>,<span class="va">...</span><span class="op">)</span></span>
<span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu">file.project</span><span class="op">(</span><span class="st">"nonmem/xgxr022.mod"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">43</span><span class="op">)</span></span>
<span><span class="co">## notice the data argument is not used.</span></span>
<span><span class="va">simres.vpc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span>,</span>
<span>                    table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>, <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>                    dir.sims<span class="op">=</span><span class="st">"testOutput"</span>,</span>
<span>                    name.sim<span class="op">=</span><span class="st">"vpc_01"</span></span>
<span>                   ,nsims<span class="op">=</span><span class="fl">500</span></span>
<span>                    <span class="op">)</span></span></code></pre></div>
<p>Similar to PSN VPC</p>
<p>Simulation results automatically read into R</p>
<p>Allows for <code>table.vars</code></p>
<p>Simulation with modified input uses same code</p>
<div class="section level3">
<h3 id="make-use-of-the-cluster">Make use of the cluster<a class="anchor" aria-label="anchor" href="#make-use-of-the-cluster"></a>
</h3>
<p>We will repeat the same as above, but now 500 times
(<code>nsims</code>). We make use of a few more arguments for
efficiency. <code>sge</code> means that the jobs will be sent to the
cluster. The <code>nc</code> argument is now used meaning only one core
will be used per job. If each node on the cluster has 16 cores, this
could engage 500/16 ~ 32 nodes in parallel, with all jobs executed at
the same time. We supply the path to the Nonmem executable. With PSN
this should work without specifying the Nonmem path, but PSN for some
reason takes more time submitting the jobs to the cluster. If nodes are
available, the following simulation should not take more than a couple
of minutes to execute.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.project</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples"</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span>,<span class="va">...</span><span class="op">)</span></span>
<span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu">file.project</span><span class="op">(</span><span class="st">"nonmem/xgxr022.mod"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">43</span><span class="op">)</span></span>
<span><span class="co">## notice the data argument is not used.</span></span>
<span><span class="va">sim.vpc.sge</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span>,</span>
<span>                     table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>, <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>                     dir.sims<span class="op">=</span><span class="st">"testOutput"</span>,</span>
<span>                     name.sim<span class="op">=</span><span class="st">"vpc_01"</span></span>
<span>                    ,nsims<span class="op">=</span><span class="fl">500</span></span>
<span>                    ,sge<span class="op">=</span><span class="cn">TRUE</span></span>
<span>                    <span class="co">## ,path.nonmem="/opt/nonmem/nm751/run/nmfe75"</span></span>
<span>                    ,path.nonmem<span class="op">=</span><span class="st">"/opt/NONMEM/nm75/run/nmfe75"</span></span>
<span>                     <span class="op">)</span></span>
<span></span>
<span><span class="va">simres.vpc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="va">sim.vpc.sge</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="plotting-using-tidyvpc">Plotting using <code>tidyvpc</code><a class="anchor" aria-label="anchor" href="#plotting-using-tidyvpc"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">NMscanData</span><span class="op">(</span><span class="va">file.mod</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model:  xgxr022 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Used tables, contents shown as used/total:</span></span>
<span><span class="co">#&gt;               file     rows columns   IDs</span></span>
<span><span class="co">#&gt;    xgxr022_res.txt  731/731   16/16 90/90</span></span>
<span><span class="co">#&gt;  xgxr2.rds (input) 731/1502   22/24 90/90</span></span>
<span><span class="co">#&gt;           (result)      731    38+2    90</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Input and output data merged by: ROW </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Distribution of rows on event types in returned data:</span></span>
<span><span class="co">#&gt;  EVID CMT output result</span></span>
<span><span class="co">#&gt;     0   2    641    641</span></span>
<span><span class="co">#&gt;     1   1     90     90</span></span>
<span><span class="co">#&gt;   All All    731    731</span></span>
<span><span class="va">data.obs</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## ggplot(data.obs,aes(TIME,DV))+</span></span>
<span><span class="co">##     geom_point()+</span></span>
<span><span class="co">##     facet_wrap(~ID)</span></span>
<span></span>
<span><span class="co">### for stratification, we need to make sure to add those variables to the sim data. </span></span>
<span><span class="co">## in case we need to create a new grouping</span></span>
<span><span class="co">## data.obs[,groupDose:=paste(STUDY,"-",DOSE,"mg")]</span></span>
<span><span class="co">## data.obs[,.N,by=.(groupDose)]</span></span>
<span></span>
<span><span class="co">## get group into sim data</span></span>
<span><span class="co">## simres &lt;- mergeCheck(simres,</span></span>
<span><span class="co">##                      findCovs(data.obs,by="ID")[,.(ID,groupDose,STUDY,DOSE)]</span></span>
<span><span class="co">##                     ,by="ID")</span></span>
<span></span>
<span></span>
<span><span class="co">## run vpc</span></span>
<span><span class="va">vpc1</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">observed</span><span class="op">(</span><span class="va">data.obs</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">TIME</span>, y <span class="op">=</span> <span class="va">DV</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">simulated</span><span class="op">(</span><span class="va">simres.vpc</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">stratify</span><span class="op">(</span><span class="op">~</span><span class="va">DOSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">binning</span><span class="op">(</span>bin <span class="op">=</span> <span class="st">"ntile"</span>, nbins <span class="op">=</span> <span class="fl">9</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">vpcstats</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">vpc1</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-VPC_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
