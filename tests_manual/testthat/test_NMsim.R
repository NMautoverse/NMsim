## install.packages("NMsim",repos="https://cloud.r-project.org")
library(data.table)
library(NMdata)

packageVersion("NMdata")
## library(NMsim)
library(devtools)
load_all(export_all=FALSE)

NMdataConf(reset=TRUE)
NMdataConf(dir.psn=NULL)
NMdataConf(as.fun="data.table")
NMdataConf(dir.sims="testOutput/simtmp")
NMdataConf(dir.res="testOutput/simres")

dt.dos <- NMcreateDoses(AMT=300,TIME=0)
dt.sim <- addEVID2(data=dt.dos,TIME=c(1,6,12),CMT=2)
dt.sim[,BBW:=40][,ROW:=.I]

dt.sim.known <- egdt(dt.sim[,!("ID")],data.table(ID=101:105))
setorder(dt.sim.known,ID,TIME,EVID,CMT)


## NMdataConf(dir.psn="/opt/psn")
## a manual linux setup
path.nonmem.custom <- "/opt/nonmem/nm751/run/nmfe75"
dir.psn.custom= "/opt/psn"


## 
path.nonmem <- "/opt/NONMEM/nm75/run/nmfe75"

if(file.exists(path.nonmem.custom)) {
    path.nonmem <- path.nonmem.custom
    NMdataConf(dir.psn=dir.psn.custom)
}

path.nonmem

file.exists(path.nonmem)

#### need a function to drop NMsimVersion and NMsimTime from table
fix.time <- function(x){
    meta.x <- attr(x,"NMsimModTab")
    ## meta.x$time.call <- as.POSIXct("2020-02-01 00:01:01",tz="UTC")
    meta.x$NMsimVersion <- NULL
    meta.x$NMsimTime <- NULL
    
    setattr(x,"NMsimModTab",meta.x)
    invisible(x)
}


#### get rid of ROWMODEL2. Not needed for NMreadSim.


context("NMsim")
test_that("basic - default",{
    
    fileRef <- "testReference/NMsim_01.rds"
    fileRef.noMeta <- fnAppend(fileRef,"noMeta")

    ## 025 doesn't seem stable. Got Q~1e7 and Nonmem didn't run
    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"
    ## NMdata:::NMreadExt( fnExtension(file.mod,"ext"))
    ## library(nonmem2R)
    ## extload(file.mod)

    set.seed(43)
    simres <- NMsim(file.mod,
                    data=dt.sim,
                    table.var="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="default_01"
                    )
    

    simres.nometa <- copy(simres)
    unNMsimRes(simres.nometa)

    expect_equal_to_reference(simres.nometa,fileRef.noMeta)
    if(F){
        ref.nometa <- readRDS(fileRef.noMeta)
simres.nometa
ref.nometa        
}
    
    ## attributes(NMreadSim("testOutput/NMsim_xgxr021_default_01_paths.rds"))
    fix.time(simres)
    ## expect_equal_to_reference(simres[,!("sim")],fileRef)
    expect_equal_to_reference(simres,fileRef)


    
    if(F){
        ref <- readRDS(fileRef)
        colnames(ref)
        colnames(simres)
        compareCols(simres,ref,keep.names=TRUE)
        ref
        simres
        compareCols(attributes(simres)$NMsimModTab,attributes(readRDS(fileRef))$NMsimModTab,keep.names=FALSE)

        
    }

})


test_that("basic - sge - dont wait",{

### using the same reference in test 1. Only diff is using sge=TRUE
    fileRef <- "testReference/NMsim_01.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"

    set.seed(43)
    ## simtab <- "testOutput/NMsim_xgxr021_default_01_paths.rds"
    ## if(doSims){
    simtab <- NMsim(file.mod,
                    data=dt.sim,
                    table.vars="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="default_01"
                   ,sge=TRUE
                    ##,reuse.results=TRUE
                    ## ,file.res=simtab
                    )
    ## }
    simres2 <- NMreadSim(simtab,wait=T)

    fix.time(simres2)
    
    expect_equal_to_reference(simres2,fileRef)
    

    if(F){
        ref <- readRDS(fileRef)
        compareCols(simres2,ref)
        simres2
        ref
        
        compareCols(attributes(simres2)$NMsimModTab,
                    attributes(ref)$NMsimModTab)
    }

    
})

test_that("basic - sge - wait",{

### using the same reference in test 1. Only diff is using sge=TRUE and wait=TRUE
    fileRef <- "testReference/NMsim_01.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"

    set.seed(43)
    ## simtab <- "testOutput/NMsim_xgxr021_default_01_paths.rds"
    ## if(doSims){
    simres3 <- NMsim(file.mod,
                     data=dt.sim,
                     table.vars="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="default_01"
                    ,sge=TRUE
                    ,wait=TRUE
                    ,reuse.results=FALSE
                     ## ,file.res=simtab
                     )
    
    fix.time(simres3)
    
    expect_equal_to_reference(simres3,fileRef)

    if(F){
        ref <- readRDS(fileRef)
        compareCols(simres3,ref)
        simres3
        ref

        compareCols(attributes(simres3)$NMsimModTab,
                    attributes(ref)$NMsimModTab)
    }

})


test_that("basic - typical",{

    fileRef <- "testReference/NMsim_02.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"
    
    set.seed(43)
    
    ## file.mod2 <- c(file.mod,  "testData/nonmem/xgxr032.mod")
    file.mod2 <- c(file.mod)
    simres2 <- NMsim(file.mod2,
                     data=dt.sim,
                     table.vars="PRED IPRED" ,
                     dir.sims="testOutput",
                     typical=TRUE,
                     name.sim="typsubj2"
                     )


    expect_equal(nrow(simres2),4)
    expect_true(simres2[,all(IPRED==PRED)])

    

    if(F){

        fix.time(simres2)
        expect_equal_to_reference(simres2,fileRef)


        ref <- readRDS(fileRef)
        compareCols(simres2,ref)

        compareCols(attributes(simres2)$NMsimModTab,
                    attributes(ref)$NMsimModTab,keep.names=FALSE)
    }

})

test_that("basic - known",{

    fileRef <- "testReference/NMsim_03.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"
    
    set.seed(43)
    simres <- NMsim(file.mod,
                    data=dt.sim.known,
                    table.vars="PRED IPRED" ,
                    ## dir.sims="testOutput",
                    method.sim=NMsim_EBE,
                    name.sim="known_01",
                    method.execute="nmsim",
                    path.nonmem=path.nonmem
                    )

    fix.time(simres)
    expect_equal_to_reference(simres,fileRef)


    if(F){
        ref <- readRDS(fileRef)
        compareCols(simres,ref)
        ref
        simres
        compareCols(attributes(simres)$NMsimModTab,
                    attributes(ref)$NMsimModTab)
    }

    
})



test_that("basic - spaces in paths",{

    fileRef <- "testReference/NMsim_04.rds"

    file.mod <- "testData/nonmem/folder with space/xgxr021.mod"

    set.seed(43)
    simres <- NMsim(file.mod,
                    data=dt.sim,
                    table.vars="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="default_01"
                    )

    unNMsimRes(simres)
    expect_equal_to_reference(simres,fileRef)

    if(F){
        ref <- readRDS(fileRef)
        compareCols(simres,ref)
        ref
        simres
    }

    
    file.mod <- "testData/nonmem/folder with space/xgxr021.mod"

    ## using PSN 
    set.seed(43)
    simres.psn <- NMsim(file.mod,
                        data=dt.sim,
                        table.vars="PRED IPRED",
                        dir.sims="testOutput",
                        name.sim="default_01",
                        method.execute="psn"
                        )

    ## no psn
    set.seed(43)
    simres.nm <- NMsim(file.mod,
                       data=dt.sim,
                       table.vars="PRED IPRED",
                       dir.sims="testOutput",
                       name.sim="default_01",
                       path.nonmem=path.nonmem,
                       method.update.inits="nmsim"
                       )

    fix.time(simres.psn)
    fix.time(simres.nm)
    
    expect_equal(simres.psn,simres.nm)

    if(F){
        compareCols(simres.psn,simres.nm)
        compareCols(attributes(simres.psn)$NMsimModTab,attributes(simres.nm)$NMsimModTab)
    }
})




test_that("SAEM - default",{

    fileRef <- "testReference/NMsim_05.rds"

    file.mod <- "testData/nonmem/xgxr032.mod"

    set.seed(43)
    simres <- NMsim(file.mod,
                    data=dt.sim,
                    table.vars="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="default_01"
                    )

    fix.time(simres)
    expect_equal_to_reference(simres,fileRef)

    
    if(F){
        ref <- readRDS(fileRef)
        ref
        simres
        compareCols(simres,ref)

        attributes(simres)
        attributes(ref)
        
        compareCols(
            attributes(simres)$NMsimModTab
           ,
            attributes(ref)$NMsimModTab
        )
    }


})


test_that("SAEM - known",{

    fileRef <- "testReference/NMsim_06.rds"

    file.mod <- "testData/nonmem/xgxr032.mod"
    ## NMreadPhi(fnExtension(file.mod,"phi"))[,unique(ID)]

    ## source("~/wdirs/NMsim/devel/genPhiFile.R")
    ## res <- NMscanData(file.mod)
    ## genPhiFile(res,file="testOutput/tmp_etas.phi")

    
    set.seed(43)
    simres <- NMsim(file.mod,
                    data=dt.sim.known,
                    table.vars="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="known_01"
                   ,method.sim=NMsim_EBE
                   ,method.execute="nmsim"
                   ,path.nonmem=path.nonmem
                    )

    ## simres.5
    fix.time(simres)
    expect_equal_to_reference(simres,fileRef)
    

    if(F){
        ref <- readRDS(fileRef)
        compareCols(simres,ref)
        simres
        ref
        ref$IPRED
        simres$IPRED
        
        compareCols(attributes(simres)$NMsimModTab,
                    attributes(ref)$NMsimModTab)
        expect_equal(
            attributes(simres)$NMsimModTab
           ,
            attributes(ref)$NMsimModTab
        )
    }


})



## rbind(simres.3,simres.5) |>
## ggplot(aes(TIME,IPRED,colour=model))+geom_line()+
## facet_wrap(~ID,scales="free")


test_that("VPC",{

    
    file.mod <- "testData/nonmem/xgxr032.mod"
    nsims <- 10
    ## nsims <- 2
    

    simres.vpc <- NMsim(file.mod,
                        table.vars="PRED IPRED Y",
                        dir.sims="testOutput",
                        name.sim="vpc01"
                       ,nsims=nsims
                       ,method.execute="nmsim"
                       ,path.nonmem=path.nonmem
                       ,seed.R=43
                        )

    ## simres.vpc <- NMreadSim("testOutput/simres/xgxr032_vpc01_MetaData.rds")

    simres.vpc[,.N,by=.(model,name.sim,model.sim)]
    expect_equal(length(unique(simres.vpc$model.sim)),nsims)

    expect_equal(nrow(simres.vpc),nsims*731)    

    ## derive PIs
    expect_equal(round(as.numeric(simres.vpc[EVID==0,quantile(Y,probs=.25)]),3),0.155)

    
})


test_that("VPC with complicated INPUT",{

    
    file.mod <- "testData/nonmem/xgxr033.mod"
    ## NMreadSection(file.mod,section="DATA")
    nsims <- 2
    ## NMexec(file.mod,sge=FALSE)
    
    set.seed(43)
    simres.vpc <- NMsim(file.mod,
                        table.vars="PRED IPRED Y",
                        dir.sims="testOutput",
                        name.sim="vpc_01"
                       ,nsims=nsims
                       ,method.execute="nmsim"
                       ,path.nonmem=path.nonmem
                        )

    ## library(ggplot2)
    ## dims(simres.vpc)
    expect_equal(length(unique(simres.vpc$model.sim)),nsims)

    expect_equal(nrow(simres.vpc),nsims*731)


})


test_that("multiple data sets",{

    fileRef <- "testReference/NMsim_07.rds"
    file.mod <- "testData/nonmem/xgxr032.mod"
    data.multiple <- split(dt.sim.known,by="ID")
    data.multiple.orig <- copy(data.multiple)

    set.seed(43)
    simres.multidata <- NMsim(file.mod,
                              data=data.multiple
                             ,table.vars="PRED IPRED Y",
                              dir.sims="testOutput"
                             ,name.sim="datalist_01"
                              ## ,method.execute="nmsim"
                             ,method.execute="psn"
                             ,sge=TRUE
                             ,wait=T
                             ,path.nonmem=path.nonmem
                              )

    expect_equal(data.multiple,data.multiple.orig)
    
    expect_equal(nrow(simres.multidata),nrow(dt.sim.known))


    
})

test_that("space in file name",{

    fileRef <- "testReference/NMsim_08.rds"
    
    fnroot <- "xgxr022"
    lapply(file.path("testData/nonmem",paste0(fnroot,".",cc(mod,lst,ext))),function(file){
        file.copy(file,file.path(dirname(file),paste0("xgxr 022.",fnExtension(file))))
    })
    file.mod <- "testData/nonmem/xgxr 022.mod"


    set.seed(43)
    simres1 <- NMsim(file.mod=c(file.mod),
                     data=dt.sim,
                     table.vars="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="space2"
                    ,path.nonmem=path.nonmem
                     )

    ## with psn
    set.seed(43)
    simres2 <- NMsim(file.mod=c("yo 3"=file.mod),
                     data=dt.sim,
                     table.vars="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="space2"
                     )

    ## name.sim has space
    set.seed(43)
    simres3 <- NMsim(file.mod=c(file.mod),
                     data=dt.sim,
                     table.vars="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="space 2"
                    ,path.nonmem=path.nonmem
                     )

### named file.mod - with space
    set.seed(43)
    simres4 <- NMsim(file.mod=c("yo 4"=file.mod),
                     data=dt.sim,
                     table.vars="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="space2"
                    ,path.nonmem=path.nonmem
                     )
    
    tab.covs <- findCovs(rbind(
        simres1[,N:=1],
        simres2[,N:=2],
        simres3[,N:=3],
        simres4[,N:=4]),by="N"
        )  
    
    expect_equal_to_reference(tab.covs,fileRef)
    if(F){
        readRDS(fileRef)
        }
    
    expect_equal(unique(
        nrow(simres1)
       ,
        nrow(simres2)
       ,
        nrow(simres3),
        nrow(simres4)
    ),4)
    

})




test_that("list of data sets - spaces in data names",{

    file.mod <- "testData/nonmem/xgxr032.mod"
    data.multiple <- split(dt.sim.known,by="ID")
    names(data.multiple) <- paste("1",names(data.multiple))

    set.seed(43)
    simres.multidata <- NMsim(file.mod,
                              data=data.multiple
                             ,table.vars="PRED IPRED Y",
                              dir.sims="testOutput"
                             ,name.sim="datalist_02"
                             ,method.execute="nmsim"
                             ,path.nonmem=path.nonmem
                              )

    simres.multidata[,.N,by=.(model,model.sim,name.sim)]
    
    expect_equal(nrow(simres.multidata),nrow(dt.sim.known))


    
})


test_that("multiple data sets on cluster",{
    file.mod <- "testData/nonmem/xgxr032.mod"
    data.multiple <- split(dt.sim.known,by="ID")
    
    set.seed(43)
    simres.multidata <- NMsim(file.mod,
                              data=data.multiple
                             ,table.vars="PRED IPRED Y",
                              dir.sims="testOutput"
                             ,name.sim="datalist_01"
                             ,method.execute="nmsim"
                             ,path.nonmem=path.nonmem
                             ,sge=TRUE
                              )

    list.files("testOutput/xgxr032_datalist_01")
    ## NMreadSim("testOutput/xgxr032_datalist_01/NMsim_paths.rds")
    class(simres.multidata)
    res <- NMreadSim(simres.multidata,wait=T)

    expect_equal(nrow(res),nrow(dt.sim.known))
    

})

test_that("default with renaming",{
    ##NMdataConf(as.fun="data.table")
    fileRef <- "testReference/NMsim_11.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"


    set.seed(43)
    simres <- NMsim(file.mod=c("ref"=file.mod),
                    data=dt.sim,
                    table.vars="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="default_01"
                    )

    expect_equal(unique(simres$model.sim),"ref_default_01_1")
    
    fix.time(simres)
    expect_equal_to_reference(simres,fileRef)
    


    if(F){
        ref <- readRDS(fileRef)
        compareCols(simres,ref)
        ref
        simres
        compareCols(
            attributes(simres)$NMsimModTab
           ,
            attributes(ref)$NMsimModTab
        )
    }


})

test_that("multiple data sets with renaming",{
    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"
    data.multiple <- split(dt.sim.known[ID<=103],by="ID")
    ## data.multiple

    set.seed(43)
    simres.multidata <- NMsim(c(ref=file.mod),
                              data=data.multiple
                             ,table.vars="PRED IPRED Y",
                              dir.sims="testOutput"
                             ,name.sim="datalist_01"
                             ,method.execute="nmsim"
                             ,path.nonmem=path.nonmem
                             ,sge=TRUE
                             ,wait=T
                              )

    expect_equal(unique(simres.multidata[,model.sim]),paste("ref_datalist_01",101:103,sep="_"))
    
    expect_equal(nrow(simres.multidata),nrow(dt.sim.known[ID<=103]))
    
})

test_that("default with nc>1",{


    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"

    set.seed(43)
    ##     expect_warning(
    
    simtab <- NMsim(file.mod,
                    data=dt.sim,
                    table.vars="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="default_nc"
                   ,method.execute="nmsim"
                    ## ,method.execute="psn"
                   ,nc=32
                   ,sge=TRUE
                   ,path.nonmem="/opt/NONMEM/nm75/run/nmfe75"
                   ,wait=F
                    )
    
    ## )

##### it seems like for nc>1 we need to wait a little bit once Nonmem is done. This is not doing that and will most likely fail.
    ##Sys.sleep(5)
    ##expect_error(
    simres <- NMreadSim(simtab,wait=T)
    ##    )

    ## if(F){
    expect_equal(
        nrow(
            simres
        ),
        nrow(dt.sim)
    )
    ## }

    ## expect_equal_to_reference(simres,fileRef)

})


test_that("transform",{
    ## options(warn=2)
    NMdataConf(reset=TRUE)
    NMdataConf(dir.res=NULL,allow.unknown=TRUE)
    NMdataConf(dir.sims=NULL,allow.unknown=TRUE)
    NMdataConf(dir.psn=NULL)
    NMdataConf(as.fun="data.table")

    fileRef <- "testReference/NMsim_09.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"

    set.seed(43)
    simres <- NMsim(file.mod,
                    data=dt.sim,
                    table.var="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="default_trans"
                   ,transform=list(IPRED=sqrt,PRED=function(x)x*1000)
                    )


    ## simres <- NMreadSim("testOutput/NMsim_xgxr021_default_trans_paths.rds")
    
    fix.time(simres)

    ## simres[,funs.transform:=NULL]
    meta.x <- attr(simres,"NMsimModTab")
    meta.x$funs.transform <- "removed"
    setattr(simres,"NMsimModTab",meta.x)

    ##     unlink(fileRef)
    expect_equal_to_reference(simres,fileRef)

    if(F){
        ref <- readRDS(fileRef)
        compareCols(simres,ref)
        ref
        simres
        
        compareCols(attributes(simres)$NMsimModTab,
                    attributes(ref)$NMsimModTab)
    }


})

test_that("dir.sims and dir.res with NMdataConf",{

    NMdataConf(dir.sims="testOutput/NMdataConfSim",
               dir.res="testOutput/NMdataConfRes"
               )
    
    fileRef <- "testReference/NMsim_10.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"
    
    set.seed(43)
    simres <- NMsim(file.mod,
                    data=dt.sim,
                    table.var="PRED IPRED",
                    name.sim="default_dirconf"
                    )

    fix.time(simres)
    
    expect_equal_to_reference(simres,fileRef)

    if(F){
        ref <- readRDS(fileRef)
        compareCols(simres,ref)
        ref
        simres
        
        compareCols(attributes(simres)$NMsimModTab,
                    attributes(ref)$NMsimModTab)
    }

    
    NMdataConf(dir.sims=NULL,
               dir.res=NULL,
               allow.unknown=TRUE)

})


test_that("basic - a model that fails on NMTRAN",{

### This used to return an error. For now, it's returning NULL.
    
    ## fileRef <- "testReference/NMsim_01.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"

    dt.dos <- NMcreateDoses(AMT=300,TIME=0)
    dt.sim <- addEVID2(data=dt.dos,TIME=c(1,6,12),CMT=2)

    set.seed(43)

    simres <- NMsim(file.mod,
                    data=dt.sim,
                    ## table.var="PRED IPRED",
                    ## dir.sims="testOutput",
                    name.sim="nmtranfail"
                   ,sge=F
                   ,seed.R=12
                   ,nmquiet=F
                   ,wait=TRUE,
                    path.nonmem=path.nonmem
                    )
    
    expect_equal(nrow(simres),0)

    expect_equal(
        nrow(NMreadSim(simres)),0
    )

### rerunning the exact same sim with reuse.results to test how a failed sim is handled.
    simres2 <- NMsim(file.mod,
                     data=dt.sim,
                     ## table.var="PRED IPRED",
                     ## dir.sims="testOutput",
                     name.sim="nmtranfail"
                    ,sge=F
                    ,seed.R=12
                    ,nmquiet=F
                    ,wait=TRUE,
                     path.nonmem=path.nonmem
                    ,reuse.results=TRUE
                     )
    
    expect_equal(fix.time(simres),fix.time(simres2))
    
})


test_that("Two models on one rds",{

    file.mod.1 <- "../../tests/testthat/testData/nonmem/xgxr021.mod"
    file.mod.2 <- "testData/nonmem/xgxr032.mod"

    dt.dos <- NMcreateDoses(AMT=300,TIME=0)
    dt.sim <- addEVID2(data=dt.dos,TIME=c(1,6,12),CMT=2)

    set.seed(43)
    simres <- NMsim(c(file.mod.1,file.mod.2),
                    data=dt.sim,
                    ## table.var="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="twomodels_01"
                   ,file.res="testOutput/twomodels_01_paths.rds"
                   ,table.vars=cc(PRED,IPRED)
                   ,sge=F
                   ,wait=TRUE
                   ,path.nonmem=path.nonmem
                    )

    ## readRDS("testOutput/twomodels_01_paths.rds")
    res <- NMreadSim("testOutput/twomodels_01_paths.rds")

    fix.time(simres)
    fix.time(res)
    
    expect_equal(simres,res)
    
})


test_that("Two named models on one rds",{

    files.mod <- c(model1="../../tests/testthat/testData/nonmem/xgxr021.mod",
                   model2="testData/nonmem/xgxr032.mod")

    dt.dos <- NMcreateDoses(AMT=300,TIME=0)
    dt.sim <- addEVID2(data=dt.dos,TIME=c(1,6,12),CMT=2)

    set.seed(43)
    simres <- NMsim(file.mod=files.mod,
                    data=dt.sim,
                    ## table.var="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="twomodels_01"
                   ,file.res="testOutput/twomodels_02_paths.rds"
                   ,table.vars=cc(PRED,IPRED)
                   ,sge=F
                   ,wait=TRUE
                    )

    simres[,.N,by=.(model,model.sim,name.sim)]
    attributes(simres)
    
    ## readRDS("testOutput/twomodels_01_paths.rds")
    res <- NMreadSim("testOutput/twomodels_02_paths.rds")

    fix.time(simres)
    fix.time(res)
    
    expect_equal(simres,res)
    
})


test_that("basic - ctl",{
    
    fileRef <- "testReference/NMsim_01_ctl.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"
    file.ctl <- fnExtension(file.mod,"ctl")
    file.copy(file.mod,file.ctl)
    
    set.seed(43)
    simres1 <- NMsim(file.ctl,
                     data=dt.sim,
                     table.var="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="default_ctl_01"
                     )

    NMdataConf(file.mod=function(file)fnExtension(file,"ctl"))

    set.seed(43)
    simres2 <- NMsim(file.ctl,
                     data=dt.sim,
                     table.var="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="default_ctl_01"
                     )

    simres <- NMreadSim("testOutput/simres/xgxr021_default_ctl_01_MetaData.rds")

    fix.time(simres1)
    fix.time(simres2)
    ## expect_equal_to_reference(simres[,!("sim")],fileRef)
    expect_equal(simres1,simres2)

    NMdataConf(file.mod=NULL)

})


### todo sim with ETA correlations with both update methods

test_that("basic - default",{
    
    fileRef <- "testReference/NMsim_12.rds"

    file.mod <- "testData/nonmem/xgxr022.mod"

    simres <- NMsim(file.mod,
                    data=dt.sim,
                    table.var="PRED IPRED Y ETAS(1:LAST)",
                    name.sim="covetas_01",
                    subproblems=5,
                    path.nonmem=path.nonmem,
                    method.update.inits="nmsim",
                    seed.R=43
                    )

    simres[,ID:=.GRP,.(ID,NMREP)]

    NMreadExt(file.mod)[par.type=="OMEGA" & i%in%c(2,3)&j%in%c(2,3)]
    omega.sim <- NMreadSection("testOutput/simtmp/xgxr022_covetas_01/xgxr022_covetas_01.mod",section="OMEGA")
    
### a check that nonmem uses te right dist is unnecessary
    ## cor(findCovs(simres,by="ID")[,.(ETA1,ETA2,ETA3,ETA4,ETA5)])
    ## cov2cor(dt2mat(NMreadExt(file.mod)[par.type=="OMEGA"]))
    

    expect_equal_to_reference(omega.sim,fileRef)

    if(F){
        ref <- readRDS(fileRef)
        ref
        omega.sim
    }
    

})


test_that("Non-numeric DATE and TIME",{

    ## requires NMdata 0.1.7
    fileRef <- "testReference/NMsim_13.rds"
    outfile <- "testOutput/NMsim_13.csv"

    file.mod <- "testData/nonmem/xgxr022.mod"

    dt.dos <- NMcreateDoses(AMT=300,TIME=0)
    dt.sim <- addEVID2(data=dt.dos,TIME=c(1,6,12),CMT=2)
    dt.sim[,BBW:=40][,ROW:=.I]

    dt.sim.known <- egdt(dt.sim[,!("ID")],data.table(ID=101:105))
    setorder(dt.sim.known,ID,TIME,EVID,CMT)

    dt.sim.char <- copy(dt.sim)

    dt.sim.char[,time.tz:=as.POSIXct("2000/01/01")+TIME*3600]
    ## dt.sim.char[,DATE:=as.character(as.Date(time.tz),format="%y/%m/%d")]
    dt.sim.char[,TIME:=as.character(time.tz,format="%H:%M:%S")]
    
    simres <- NMsim(file.mod,
                    data=dt.sim.char,
                    table.var="TIME PRED IPRED",
                    name.sim="timeAsChar_01",
                    path.nonmem=path.nonmem,
                    method.update.inits="nmsim",
                    seed.R=43
                    ##,quiet=TRUE
                    )


    ## TIME from input data
    simres.inp <- NMsim(file.mod,
                        data=dt.sim.char,
                        table.var="PRED IPRED",
                        name.sim="timeAsChar_02",
                        path.nonmem=path.nonmem,
                        method.update.inits="nmsim",
                        seed.R=43,
                        quiet=TRUE
                        )

    ## TIME from input data because its in carry.out
    simres.inp2 <- NMsim(file.mod,
                         data=dt.sim.char,
                         table.var="PRED IPRED",
                         carry.out="TIME",
                         name.sim="timeAsChar_03",
                         path.nonmem=path.nonmem,
                         method.update.inits="nmsim",
                         seed.R=43,
                         quiet=TRUE
                         )

    
    res <- list(
        timeout=simres[,lapply(.SD,NMisNumeric),.SDcols=cc(TIME)]==TRUE
       ,
        timein=simres.inp[,lapply(.SD,NMisNumeric),.SDcols=cc(TIME)]==FALSE
       ,
        timein2=simres.inp2[,lapply(.SD,NMisNumeric),.SDcols=cc(TIME)]==FALSE
    )

    expect_equal_to_reference(
        res
       ,
        fileRef
    )



### DATE is not allowed in $TABLE. We are not testing this because for some reason we are getting issues when DATE is in input data.
    if(F){
        expect_error(
            simres <- NMsim(file.mod,
                            data=dt.sim.char,
                            table.var="TIME PRED IPRED",
                            name.sim="timeAsChar_01",
                            path.nonmem=path.nonmem,
                            method.update.inits="nmsim",
                            seed.R=43
                            ##,quiet=TRUE
                            )
        )
    }
    
})

test_that("as.fun=data.table in function call",{
    NMdataConf(reset=TRUE)
    NMdataConf(path.nonmem = "/opt/NONMEM/nm75/run/nmfe75")
    
    fileRef <- "testReference/NMsim_01.rds"

    ## 025 doesn't seem stable. Got Q~1e7 and Nonmem didn't run
    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"

    dt.dos <- NMcreateDoses(AMT=300,TIME=0,as.fun="data.table")
    dt.sim <- addEVID2(data=dt.dos,TIME=c(1,6,12),CMT=2,as.fun="data.table")
    dt.sim[,BBW:=40][,ROW:=.I]

    
    set.seed(43)
    simres <- NMsim(file.mod,
                    data=dt.sim,
                    table.var="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="gjerkjng",
                    as.fun="data.table"
                    )

    expect_true(is.data.table(simres))

})



###### using nmsim2 update inits method

test_that("basic - nmsim update inits",{
    NMdataConf(reset=TRUE)
    NMdataConf(path.nonmem = "/opt/NONMEM/nm75/run/nmfe75",
               as.fun="data.table")
    NMdataConf(dir.sims="testOutput/simtmp")
    NMdataConf(dir.res="testOutput/simres")


    fileRef <- "testReference/NMsim_14.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"

    set.seed(43)
    simres <- NMsim(file.mod,
                    data=dt.sim,
                    table.var="PRED IPRED",
                    dir.sims="testOutput",
                    name.sim="default_14",
                    inits=list(update=TRUE),
                    path.nonmem=path.nonmem
                    )
    
    ## attributes(NMreadSim("testOutput/NMsim_xgxr021_default_01_paths.rds"))
    fix.time(simres)
    ## expect_equal_to_reference(simres[,!("sim")],fileRef)
    expect_equal_to_reference(simres,fileRef)

    if(F){
        readRDS(fileRef)
        simres
    }
    
})


###### using nmsim2 update inits method and modify parameter

test_that("basic - nmsim update inits",{
    
    ## fileRef <- "testReference/NMsim_15.rds"

    file.mod <- "../../tests/testthat/testData/nonmem/xgxr021.mod"

    set.seed(43)
    simres2 <- NMsim(file.mod,
                     data=dt.sim,
                     table.var="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="default_15",
                     inits=list(update=TRUE,values=list("THETA(2)"=list(init=4))),
                     path.nonmem=path.nonmem
                     )

    simres3 <- NMsim(file.mod,
                     data=dt.sim,
                     table.var="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="default_16",
                     inits=list("THETA(2)"=list(init=4)),
                     path.nonmem=path.nonmem
                     )


    simres4 <- NMsim(file.mod,
                     data=dt.sim,
                     table.var="PRED IPRED",
                     dir.sims="testOutput",
                     name.sim="default_17",
                     inits=list("THETA(2)"=list(init=4,fix=1,upper=34)),
                     path.nonmem=path.nonmem
                     )


    
    expect_error(NMsim(file.mod,
                       data=dt.sim,
                       table.var="PRED IPRED",
                       dir.sims="testOutput",
                       name.sim="default_18",
                       inits=list("THETA(2)"=list(init=4,fix=1,upprr=34)),
                       path.nonmem=path.nonmem
                       ))

    

})


test_that("fast tables",{
    NMdataConf(reset=TRUE)
    NMdataConf(as.fun="data.table")
    NMdataConf(dir.sims="testOutput/simtmp")
    NMdataConf(dir.res="testOutput/simres")
    

    dt.sim <- NMcreateDoses(TIME=0,ADDL=100,II=24,AMT=40) |>
        addEVID2(TAPD=seq(0.25,24,by=.25),CMT=2)

    dt.sim[,WTBLI:=75]

    file.mod <- "~/wdirs/NMsim/tests/testthat/testData/nonmem/xgxr032.mod"
    ## readLines(file.mod)


    tabopts <- c("NOPRINT","NOPRINT NOAPPEND","NOPRINT NOAPPEND ONEHEADER")
    tabopts <- c("NOPRINT",
                 "NOPRINT NOAPPEND",
                 "NOPRINT NOAPPEND ONEHEADER",
                 "NOPRINT NOAPPEND ONEHEADER NOTITLE",
                 "NOPRINT NOAPPEND ONEHEADERALL NOTITLE"
                 )

    Iopts <- 5
    name.sim <- paste0("tabopts",Iopts)

    res1 <- NMsim(file.mod=file.mod,
                  data=dt.sim,
                  name.sim=name.sim,
                  table.vars=cc(PRED,IPRED,Y)
                  ## ,subproblems=2
                  ## ,modify.model=list(error=add("NMREP=IREP"))
                  ## ,table.options=tabopts[Iopts]
                 ,carry.out="TAPD"
                  )
    attributes(res1)
    
    res2 <- NMsim(file.mod=file.mod,
                  data=dt.sim,
                  name.sim="nmrep_subprob",
                  table.vars=cc(PRED,IPRED,Y,NMREP)
                 ,subproblems=2
                  ## modify.model=list(error=add("NMREP=IREP"))
                  ## ,table.options=tabopts[Iopts]
                 ,carry.out=c("TAPD","WTBLI")
                  )

    
    
})


test_that("subproblems and nsims",{
    
    fileRef <- "testReference/NMsim_16.rds"

    file.mod <- "testData/nonmem/xgxr022.mod"

    simres <- NMsim(file.mod,
                    data=dt.sim,
                    table.vars="PRED IPRED Y",
                    name.sim="subprob_nsims",
                    subproblems=5,
                    nsims=2,
                    path.nonmem=path.nonmem
                   ,
                    method.update.inits="nmsim",
                    seed.R=43
                   ,as.fun="data.table")

    simres[,ID:=.GRP,.(ID,NMREP)]
    fix.time(simres)
    
    expect_equal_to_reference(simres,fileRef)

    if(F){
        ref <- readRDS(fileRef)
        simres
        ref
        omega.sim
    }
    

})

