---
title: "Creation of Simulation Data Sets"
output:
rmarkdown::html_vignette:
    toc: true
    code_folding: show
Suggests: markdown
VignetteBuilder: knitr
vignette: >
  %\VignetteIndexEntry{06dsCreate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
header-includes:
- \usepackage{ae}
---

```{r,include = FALSE}
##knitr::opts_chunk$set(dev = "cairo_pdf")
knitr::opts_chunk$set(
                      collapse = TRUE
                     ,comment = "#>"
                     ,fig.width=7
                     ,cache=FALSE
                  )

## this changes data.table syntax. I think we can do without.
## knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=TRUE)
```

```{r,setup,include=F}
## library(devtools)
## unloadNamespace("NMsim")
## unloadNamespace("NMdata")

## load_all("~/wdirs/NMdata")
## load_all()
library(NMsim)
library(data.table)
library(NMdata)
library(ggplot2)
library(patchwork)
library(tracee)
library(fst)
library(knitr)
## NMdataConf(path.nonmem="/opt/NONMEM/nm75/run/nmfe75")
## NMdataConf(path.nonmem="/opt/nonmem/nm751/run/nmfe75")
## NMdataConf(dir.psn=NULL)

theme_set(theme_bw())
this.script <- "NMsim-DataCreate.Rmd"
writeOutput <- TRUE
file.project <- function(...)file.path(system.file("examples",package="NMsim"),...)
## file.project <- function(...)file.path("../inst/examples",...)
## file.project <- function(...)file.path("~/wdirs/NMsim/inst/examples",...)


run.simuls <- FALSE
NMdataConf(as.fun="data.table")
```

Built `r Sys.Date()` using NMsim `r packageVersion("NMsim")`.



### Generating a simulation input data set
The pop PK model was estimated using an ADVAN subroutine with
extravascular dosing in compartment 1 and the central compartment is
compartment 2. This information is needed because the compartment
numbers in the simulation data set will be created to match this. We
shall see that this is the only information needed about the model for
`NMsim` to be able to simulate it.

It does not matter to NMsim how we create a simulation data set as
long as we get it into a data.frame structure. For the example, we used functions
included with NMsim, but you can use anything. We
create a regimen with a loading dose of 300 mg followed by 150 QD for
6 days. Notice that the compartment numbers match the compartment
numbers that were used when estimating the model.

```{r,dsCreateSim,include=TRUE}
### multiple dose regimens with loading are easily created with NMcreateDoses too
## We use ADDL+II (either method easy)
doses <- NMcreateDoses(TIME=c(0,24),AMT=c(300,150),addl=data.frame(ADDL=c(0,5),II=c(0,24)),CMT=1)
doses <- transform(doses,trt="300 mg then 150 mg QD")

## Add simulation records - longer for QD regimens
dat.sim <- addEVID2(doses,time.sim=0:(24*7),CMT=2)

## sort data set 
setorder(dat.sim,ID,TIME,EVID)

## Adding a row identifier (generally not necessary)
dat.sim$ROW <- 1:nrow(dat.sim)
```
```{r,save-datsim,eval=FALSE}
NMwriteData(dat.sim,file="simulate-results/dat_sim.csv",genText=FALSE)
```

We check the simulation data set for various potential issues in
Nonmem data sets using `NMdata::NMcheckData` and summarize the number
of doses and observations:

```{r}
NMcheckData(dat.sim,type.data="sim")
```

A brief overview of the number of events broken down by event type `EVID` and dose amount `AMT`:

```{r,echo=FALSE}
NMexpandDoses(dat.sim)[,.(Nrows=.N),keyby=.(trt,EVID,AMT)] |>
    kable()
```

Showing the top five rows for understanding what the data now looks like. Notice that the following are _not_ issues:

- Data contains a mix of numeric and non-numeric columns
- Columns are not sorted in Nonmem-friendly style with non-numeric columns to the right


```{r,echo=FALSE}
dat.sim[1:5,]
```
