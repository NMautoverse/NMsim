##' Read simulation results based on NMsim's track of model runs
##' @param x Path to the simulation-specific rds file generated by
##'     NMsim, typically called `NMsim_paths.rds`. Or a table of
##'     simulation runs as returned by NMsim when `wait=FALSE`.
##' @param as.fun The default is to return data as a data.frame. Pass
##'     a function (say tibble::as_tibble) in as.fun to convert to
##'     something else. If data.tables are wanted, use
##'     as.fun="data.table". The default can be configured using
##'     NMdataConf.
##' @return A data set of class defined by as.fun
##' @export

NMreadSim <- function(x,as.fun){

    . <- NULL
    ROWMODEL2 <- NULL
    args.NMscanData <- NULL
    path.sim.lst <- NULL
    simres <- NULL

    if(missing(as.fun)) as.fun <- NULL
    as.fun <- NMdata:::NMdataDecideOption("as.fun",as.fun)


    ## when to look for combined and saved results?


    ## if path is a dir, search for rds
    
    ## if an rds, just read it
    if(!is.list(x) && is.character(x)) {
        tab.paths <- readRDS(x)
        
        if(!inherits(tab.paths,"NMsimTab")) {
            stop("The provided rds file does not contain a NMsimTab object")
        }
    } else if(is.NMsimTab(x)){
        tab.paths <- x
    }
    
    ## if an lst, read it


### read all sim results
    res <- tab.paths[,{
    ## the rds table must keep NMscanData arguments
        args.NM <- args.NMscanData[[1]]
        if(! "quiet" %in% names(args.NM)){
            args.NM$quiet <- TRUE
        }
        
        do.call(NMscanData,c(list(file=path.sim.lst),args.NM))
    },keyby=.(ROWMODEL2)]
    return(res)
    


    return(as.fun(simres))
}
