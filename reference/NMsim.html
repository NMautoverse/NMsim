<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Supply a data set and an input control stream, and NMsim can
create neccesary files, run the simulation and read the
results. It has additional methods for other siulation types
available, can do multiple simulations at once and more. Please
see vignettes for an introcution to how to get the most out of
this."><title>Run simulations from an estimated Nonmem model — NMsim • NMsim</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run simulations from an estimated Nonmem model — NMsim"><meta property="og:description" content="Supply a data set and an input control stream, and NMsim can
create neccesary files, run the simulation and read the
results. It has additional methods for other siulation types
available, can do multiple simulations at once and more. Please
see vignettes for an introcution to how to get the most out of
this."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/NMsim-config.html">NMsim Configuration</a>
    <a class="dropdown-item" href="../articles/NMsim-simulate.html">NMsim Simulation Methods</a>
  </div>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/philipdelff/NMsim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Run simulations from an estimated Nonmem model</h1>
      <small class="dont-index">Source: <a href="https://github.com/philipdelff/NMsim/blob/HEAD/R/NMsim.R" class="external-link"><code>R/NMsim.R</code></a></small>
      <div class="d-none name"><code>NMsim.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Supply a data set and an input control stream, and NMsim can
create neccesary files, run the simulation and read the
results. It has additional methods for other siulation types
available, can do multiple simulations at once and more. Please
see vignettes for an introcution to how to get the most out of
this.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">NMsim</span><span class="op">(</span></span>
<span>  <span class="va">file.mod</span>,</span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">dir.sims</span>,</span>
<span>  <span class="va">name.sim</span>,</span>
<span>  order.columns <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  script <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  subproblems <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  reuse.results <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">seed</span>,</span>
<span>  <span class="va">args.psn.execute</span>,</span>
<span>  nmquiet <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">text.table</span>,</span>
<span>  <span class="va">type.mod</span>,</span>
<span>  method.sim <span class="op">=</span> <span class="va">NMsim_default</span>,</span>
<span>  execute <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  sge <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  transform <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">type.input</span>,</span>
<span>  <span class="va">method.execute</span>,</span>
<span>  <span class="va">method.update.inits</span>,</span>
<span>  create.dir <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">dir.psn</span>,</span>
<span>  <span class="va">list.sections</span>,</span>
<span>  sim.dir.from.scratch <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  path.nonmem <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">as.fun</span>,</span>
<span>  <span class="va">suffix.sim</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>file.mod</dt>
<dd><p>Path(s) to the input control stream(s) to run the
simulation on. The outpult control stream is for now assumed
to be stored next to the input control stream and ending in
.lst instead of .mod. The .ext file must also be present. If
simulating known subjects, the .phi is necessary too.</p></dd>


<dt>data</dt>
<dd><p>The simulation data as a data.frame.</p></dd>


<dt>dir.sims</dt>
<dd><p>The directory in which NMsim will store all
generated files.</p></dd>


<dt>name.sim</dt>
<dd><p>Give all filenames related to the simulation a
suffix. A short string describing the sim is recommended like
"ph3_regimens".</p></dd>


<dt>order.columns</dt>
<dd><p>reorder columns by calling
NMdata::NMorderColumns before saving dataset and running
simulations? Default is TRUE.</p></dd>


<dt>script</dt>
<dd><p>The path to the script where this is run. For
stamping of dataset so results can be traced back to code.</p></dd>


<dt>subproblems</dt>
<dd><p>Number of subproblems to use as SUBPROBLEMS in
$SIMULATION block in Nonmem. The default is subproblem=0 which
means not to use SUBPROBLEMS.</p></dd>


<dt>reuse.results</dt>
<dd><p>If simulation results found on file, should
they be used? If TRUE and reading the results fail, the
simulations will still be rerun.</p></dd>


<dt>seed</dt>
<dd><p>Seed to pass to Nonmem. Default is to draw one betwen
0 and 2147483647 (the values supported by Nonmem) for each
simulation. In case type.sim=known, seed is not used and will
be set to 1. You can pass a function that will be evaluated
(say to choose a different pool of seeds to draw from).</p></dd>


<dt>args.psn.execute</dt>
<dd><p>A charachter string that will be passed as
arguments PSN's `execute`.</p></dd>


<dt>nmquiet</dt>
<dd><p>Silent messages from Nonmem.</p></dd>


<dt>text.table</dt>
<dd><p>A character string including the variables to
export from Nonmem. The default is to export the same tables
as listed in the input control stream. But if many variables
are exported, and much fewer are used, it can speed up NMsim
significantly to only export what is needed (sometimes this is
as little as "PRED IPRED"). Nonmem writes data slowly so
reducing output data from say 100 columns to a handful makes a
big difference.</p></dd>


<dt>type.mod</dt>
<dd><p>The control stream "type". Default is "est"
meaning that an $ESTIMATION block will be replaced by a
"$SIMULATION" block, and parameter estimates should be taken
from the estimation results. If the control stream has already
been turned into a simulation control stream, and only $INPUT,
$DATA, and $TABLE sections should be edited. This implies that
in case type.mod="sim", `subproblems` is ignored. `type.mod`
may be automated in the future.</p></dd>


<dt>method.sim</dt>
<dd><p>A function (not quoted) that creates the
simulation control stream and other necessary files for a
simulation based on the estimation control stream, the data,
etc. The default is called <code>NMsim_default</code> which will
replace any estimation and covariance step by a simulation
step. See details section on oter methods, and see examples
and especially vignettes on how to use the different provided
methods.</p></dd>


<dt>execute</dt>
<dd><p>Execute the simulation or only prepare it?
`execute=FALSE` can be useful if you want to do additional
tweaks or simulate using other parameter estimates.</p></dd>


<dt>sge</dt>
<dd><p>Submit to cluster? Default is not to, but this is very
useful if creating a large number of simulations,
e.g. simulate with all parameter estimates from a bootstrap
result.</p></dd>


<dt>transform</dt>
<dd><p>A list defining transformations to be applied
after the Nonmem simulations and before plotting. For each
list element, its name refers to the name of the column to
transform, the contents must be the function to apply.</p></dd>


<dt>type.input</dt>
<dd><p>Deprecated. Use type.mod instead.</p></dd>


<dt>method.execute</dt>
<dd><p>Specify how to call Nonmem. Options are
"psn" (PSN's execute), "nmsim" (an internal method similar to
PSN's execute), and "direct" (just run Nonmem directly and
dump all the temporary files). "nmsim" has advantages over
"psn" that makes it the only supported method when
type.sim="NMsim_known". "psn" has the simple advantage that
the path to nonmem does not have to be specified if "execute"
is in the system search path. So as long as you know where
your Nonmem executable is, "nmsim" is recommended. The default
is "nmsim" if path.nonmem is specified, and "psn" if not.</p></dd>


<dt>method.update.inits</dt>
<dd><p>The initial estimates must be updated
from the estimated model before running the simulation. NMsim
supports two ways of doing this: "psn" which uses PSN's
"update_inits", and "nmsim" which uses a simple internal
method. The advantage of "psn" is it keeps comments in the
control stream and is a method known to many. The advantages
of "nmsim" are it does not require PSN, and that it is very
robust. "nmsim" fixes the whole OMEGA and SIGMA matrices as
single blocks making the $OMEGA and $SIGMA sections of the
control streams less easy to read. On the other hand, this
method is robust because it avoids any interpretation of BLOCK
structure or other code in the control streams.</p></dd>


<dt>create.dir</dt>
<dd><p>If the directory specified in dir.sims does not
exists, should it be created? Default is TRUE.</p></dd>


<dt>dir.psn</dt>
<dd><p>The directory in which to find PSN's executables
('execute' and 'update_inits'). The default is to rely on the
system's search path. So if you can run 'execute' and
'update_inits' by just typing that in a terminal, you don't
need to specify this unless you want to explicitly use a
specific installation of PSN on your system.</p></dd>


<dt>list.sections</dt>
<dd><p>Named list of additional control stream
section edits. Note, these can be functions that define how to
edit sections. This is an advanced feature which is not needed
to run most simulations. It is however powerful for some types
of analyses, like modifying parameter values. See vignettes
for further information. Documentation still under
development.</p></dd>


<dt>sim.dir.from.scratch</dt>
<dd><p>If TRUE (default) this will wipe the
simulation directory before running new simulations. The
directory that will be emptied is _not_ dir.sims where you may
keep many or all your simulations. It is the subdirectory
named based on the run name and <code>name.sim</code>. The reason it
is advised to wipe this directory is that if you in a previous
simulation created simulation runs that are now obsolete, you
could end up reading those too when collecting the
results. NMsim will delete previously generated simulation
control streams with the same name, but this option goes
further. An example where it is important is if you first ran
1000 replications, fixed something and now rand 500. If you
choose FALSE here, you can end up with the results of 500 new
and 500 old simulations.</p></dd>


<dt>path.nonmem</dt>
<dd><p>The path to the Nonmem executable to use. The
could be something like "/usr/local/NONMEM/run/nmfe75" (which
is a made up example). No default is available. You should be
able to figure this out through how you normally execute
Nonmem, or ask a colleague.</p></dd>


<dt>as.fun</dt>
<dd><p>The default is to return data as a data.frame. Pass
a function (say tibble::as_tibble) in as.fun to convert to
something else. If data.tables are wanted, use
as.fun="data.table". The default can be configured using
NMdataConf.</p></dd>


<dt>suffix.sim</dt>
<dd><p>Deprecated. Use name.sim instead.</p></dd>


<dt>...</dt>
<dd><p>Additional arguments passed to <code>method.sim</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A data.frame with simulation results (same number of rows
    as input data). If `wait=FALSE` a character vector with paths
    to simulation control streams.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Loosely speaking, the argument <code>method.sim</code> defines
    _what_ NMsim will do, <code>method.executes</code> define _how_ it
    does it. <code>method.sim</code> takes a function that converts an
    estimation control stream into whatever should be
    run. Features like replacing `$INPUT`, `$DATA`, `$TABLE`, and
    handling seeds are NMsim features that are done in addition to
    the <code>method.sim</code>. Also the <code>list.sections</code> argument
    is handled in addition to the <code>method.sim</code>. The
    <code>subproblems</code> and <code>seed</code> arguments are available to
    all methods creating a <code>$SIMULATION</code> section.</p>
<p>Notice, the following functions are internally available to
`NMsim` so you can run them by say <code>method.sim=NMsim_known</code>
without quotes. To see the code of that method, type
<code>NMsim:::NMsim_known</code>.</p>
<ul><li><p><code>NMsim_default</code> The default behaviour. Replaces any
$ESTIMATION and $COVARIANCE sections by a $SIMULATION section.</p></li>
<li><p><code>NMsim_asis</code> The simplest of all method. It does nothing (but
again, <code>NMsim</code> handles `$INPUT`, `$DATA`, `$TABLE` and
more. Use this for instance if you already created a simulation
(or estimation actually) control stream and want NMsim to run it
on different data sets.</p></li>
<li><p><code>NMsim_typical</code> Like <code>NMsim_default</code> but with all
ETAs=0, giving a "typical subject" simulation. Do not confuse this
with a "reference subject" simulation which has to do with
covariate values. Technically all ETAs=0 is obtained by replacing
<code>$OMEGA</code> by a zero matrix.</p></li>
<li><p><code>NMsim_known</code> Simulates _known_ subjects, meaning that
it reuses ETA values from estimation run. This is what is refered
to as emperical Bayes estimates. The .phi file from the estimation
run must be found next to the .lst file from the estimation.This
means that ID values in the (simulation) input data must be ID
values that were used in the estimation too. Runs an
<code>$ESTIMATION MAXEVAL=0</code> but pulls in ETAs for the ID's found
in data. No <code>$SIMULATION</code> step is run which may affect how
for instance residual variability is simulated, if at all.</p></li>
<li><p><code>NMsim_VarCov</code> Like <code>NMsim_default</code> but `$THETA`,
`$OMEGA`, and `SIGMA` are drawn from distribution estimated in
covariance step. This means that a successful covariance step must
be available from the estimation. In case the simulation leads to
negative diagonal elements in $OMEGA and $SIGMA, those values are
truncated at zero. For simulation with parameter variability based
on bootstrap results, use <code>NMsim_default</code>.</p></li>
</ul></div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script></body></html>

